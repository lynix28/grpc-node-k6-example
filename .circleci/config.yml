version: 2.1
jobs:
  Build-and-Test:
    docker:
      - image: node
    steps:
      - checkout
      - run: 
          name: "Preparing Test"
          command: |
            npm install
            apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
            echo "deb https://dl.k6.io/deb stable main" | tee /etc/apt/sources.list.d/k6.list
            apt-get update
            apt-get install k6
            mkdir client/reports
      - run:
          name: "Launch Server"
          command: npm run server &
      - run:
          name: "Storing Local IP Address"
          command: |
            IPaddress=`node -p "require('ip').address()"`
            echo "export const BASE_URL = $IPaddress;" > env.js
      - run:
          name: "Waiting for Node Server to Start"
          command: wget --retry-connrefused --waitretry=2 -t 5 "http://$IPaddress:50051" > /dev/null
      - run:
          name: "Run Test"
          command: npm run test
      - store_artifacts:
          path: reports/

workflows:
  Loadtest-Workflow:
    jobs:
      - Build-and-Test
